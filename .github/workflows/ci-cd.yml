name: CI → Dev/Prd

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, closed]
  push:
    branches-ignore: [main]
  workflow_dispatch:
    inputs:
      target:
        description: 'Manual deploy target'
        required: false
        default: dev
        type: choice
        options: [dev, prd]

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ---------- PREP ----------
  install_dependencies:
    name: Install dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Save deps cache
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}

  # ---------- TEST/ANALYZE ----------
  check_types:
    name: Type check
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
      - run: npx tsc --noEmit

  eslint:
    name: ESLint
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
      - run: npx eslint . --max-warnings=0

  prettier:
    name: Prettier check
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
      - run: npx prettier -c .

  unit_test:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
      - run: npm test -- --ci

  # ---------- PLAN / VALIDATION ----------
  tf_plan_dev:
    name: TF plan (dev)
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Write service account credentials
        run: |
          cat <<'EOF' > terraform/dev/service-account-dev.json
          ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          EOF
      - name: Terraform init
        working-directory: terraform/dev
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/terraform/dev/service-account-dev.json
        run: terraform init
      - name: Terraform plan
        working-directory: terraform/dev
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/terraform/dev/service-account-dev.json
        run: terraform plan -lock=false

  tf_plan_prd:
    name: TF plan (prd)
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    if: >
      (github.event_name == 'pull_request' &&
       github.event.action == 'closed' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main')
      || (github.event_name == 'workflow_dispatch' && inputs.target == 'prd')
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Write service account credentials
        run: |
          cat <<'EOF' > terraform/prd/service-account-prd.json
          ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRD }}
          EOF
      - name: Terraform init
        working-directory: terraform/prd
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/terraform/prd/service-account-prd.json
        run: terraform init
      - name: Terraform plan
        working-directory: terraform/prd
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/terraform/prd/service-account-prd.json
        run: terraform plan -lock=false

  # ---------- BUILD ----------
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
      - run: npm run build --if-present

  # ---------- DEPLOY: DEV ----------
  deploy_dev:
    name: Deploy → dev
    runs-on: ubuntu-latest
    needs: [build, tf_plan_dev]
    environment:
      name: dev
    if: >
      (github.event_name == 'push' && github.ref != 'refs/heads/main')
      || (github.event_name == 'workflow_dispatch' && inputs.target == 'dev')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm ci
      - name: Build project
        env:
          NODE_ENV: dev
          VITE_ENV: dev
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
          VITE_FIRESTORE_DATABASE_ID: ${{ secrets.VITE_FIRESTORE_DATABASE_ID_DEV }}
        run: npm run build
      - name: Deploy to Firebase Hosting (Dev)
        uses: FirebaseExtended/action-hosting-deploy@v0
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
          VITE_FIRESTORE_DATABASE_ID: ${{ secrets.VITE_FIRESTORE_DATABASE_ID_DEV }}
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          projectId: sawa-explorer-dev
          channelId: live
      - name: Install Functions dependencies
        run: cd functions && npm ci
      - name: Write .env (dev)
        run: |
          mkdir -p functions
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY_DEV }}" > functions/.env
      - name: Deploy Firebase Functions (dev)
        run: |
          npm i -g firebase-tools
          firebase deploy --only functions --project dev --token ${{ secrets.FIREBASE_TOKEN_DEV }} --force

  # ---------- DEPLOY: PRD (after merge) ----------
  deploy_prd:
    name: Deploy → prd
    runs-on: ubuntu-latest
    needs: [build, tf_plan_prd]
    environment:
      name: prd # must match your GitHub Environment
      # url: https://your-prd-url.example.com   # optional
    if: >
      (github.event_name == 'pull_request' &&
       github.event.action == 'closed' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main')
      || (github.event_name == 'workflow_dispatch' && inputs.target == 'prd')
    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm ci
      - name: Build project
        env:
          NODE_ENV: prd
          VITE_ENV: prd
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY_PRD }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_PRD }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID_PRD }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PRD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_PRD }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID_PRD }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_PRD }}
          VITE_FIRESTORE_DATABASE_ID: ${{ secrets.VITE_FIRESTORE_DATABASE_ID_PRD }}
        run: npm run build
      - name: Deploy to Firebase Hosting (Prd)
        uses: FirebaseExtended/action-hosting-deploy@v0
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY_PRD }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_PRD }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID_PRD }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PRD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_PRD }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID_PRD }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_PRD }}
          VITE_FIRESTORE_DATABASE_ID: ${{ secrets.VITE_FIRESTORE_DATABASE_ID_PRD }}
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRD }}
          projectId: sawa-explorer
          channelId: live
      - name: Install Functions dependencies
        run: cd functions && npm ci
      - name: Write .env (prd)
        run: |
          mkdir -p functions
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY_PRD }}" > functions/.env
      - name: Deploy Firebase Functions (prd)
        run: |
          npm i -g firebase-tools
          firebase deploy --only functions --project prd --token ${{ secrets.FIREBASE_TOKEN_PRD }} --force
